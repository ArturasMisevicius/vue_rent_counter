name: Performance Monitoring & N+1 Query Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  n1-query-detection:
    runs-on: ubuntu-latest
    
    services:
      sqlite:
        image: alpine:latest
        options: >-
          --health-cmd "echo 'SQLite ready'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, sqlite3, pdo_sqlite
        coverage: xdebug

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Setup Laravel environment
      run: |
        cp .env.example .env
        php artisan key:generate
        php artisan config:cache

    - name: Create SQLite database
      run: |
        mkdir -p database
        touch database/database.sqlite

    - name: Run database migrations
      run: php artisan migrate --force

    - name: Run N+1 Query Detection Tests
      run: |
        php artisan test tests/Performance/ServiceValidationEngineN1QueryTest.php \
          --coverage-clover=coverage.xml \
          --log-junit=test-results.xml \
          --testdox

    - name: Performance Benchmark Tests
      run: |
        php artisan test tests/Performance/ \
          --filter="performance|benchmark" \
          --testdox

    - name: Generate Performance Report
      run: |
        php artisan performance:analyze \
          --output=performance-report.json \
          --format=json

    - name: Check Performance Thresholds
      run: |
        php artisan performance:check-thresholds \
          --max-queries-per-reading=0.15 \
          --max-duration-seconds=1.0 \
          --max-memory-mb=50

    - name: Upload Performance Artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-reports
        path: |
          performance-report.json
          test-results.xml
          coverage.xml

    - name: Comment PR with Performance Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('performance-report.json', 'utf8'));
            
            const comment = `## ðŸš€ Performance Analysis Results
            
            ### N+1 Query Detection
            - **Batch Validation (100 readings)**: ${report.batch_validation.query_count} queries
            - **Single Reading Validation**: ${report.single_validation.query_count} queries
            - **Memory Usage**: ${report.memory_usage.peak_mb} MB peak
            - **Execution Time**: ${report.execution_time.batch_ms}ms for batch
            
            ### Performance Thresholds
            ${report.thresholds.queries_per_reading <= 0.15 ? 'âœ…' : 'âŒ'} Queries per reading: ${report.thresholds.queries_per_reading}
            ${report.thresholds.duration_seconds <= 1.0 ? 'âœ…' : 'âŒ'} Duration: ${report.thresholds.duration_seconds}s
            ${report.thresholds.memory_mb <= 50 ? 'âœ…' : 'âŒ'} Memory usage: ${report.thresholds.memory_mb} MB
            
            ### Recommendations
            ${report.recommendations.join('\n')}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read performance report:', error.message);
          }

  performance-regression-detection:
    runs-on: ubuntu-latest
    needs: n1-query-detection
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, sqlite3

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Setup test environment
      run: |
        cp .env.example .env
        php artisan key:generate
        touch database/database.sqlite
        php artisan migrate --force

    - name: Run Performance Baseline Tests
      run: |
        php artisan performance:baseline \
          --output=baseline-current.json

    - name: Download Previous Baseline
      uses: actions/download-artifact@v3
      continue-on-error: true
      with:
        name: performance-baseline
        path: ./

    - name: Compare Performance Baselines
      run: |
        php artisan performance:compare \
          --current=baseline-current.json \
          --previous=baseline-previous.json \
          --threshold=10 \
          --output=comparison-report.json

    - name: Upload Current Baseline
      uses: actions/upload-artifact@v3
      with:
        name: performance-baseline
        path: baseline-current.json

    - name: Fail on Performance Regression
      run: |
        php artisan performance:validate-regression \
          --report=comparison-report.json \
          --max-regression-percent=20

  database-query-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, sqlite3

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Analyze Database Queries
      run: |
        php artisan db:analyze-queries \
          --class="App\Services\ServiceValidationEngine" \
          --method="batchValidateReadings" \
          --sample-size=100 \
          --output=query-analysis.json

    - name: Check for N+1 Patterns
      run: |
        php artisan db:detect-n1 \
          --analysis=query-analysis.json \
          --threshold=0.5 \
          --fail-on-detection

    - name: Generate Query Optimization Suggestions
      run: |
        php artisan db:suggest-optimizations \
          --analysis=query-analysis.json \
          --output=optimization-suggestions.md

    - name: Upload Query Analysis
      uses: actions/upload-artifact@v3
      with:
        name: query-analysis
        path: |
          query-analysis.json
          optimization-suggestions.md