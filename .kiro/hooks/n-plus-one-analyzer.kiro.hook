{
  "enabled": true,
  "name": "N+1 Query Analyzer & Fixer",
  "description": "Automatically analyzes PHP/Laravel code for N+1 query problems when controllers, services, or models are edited. Provides comprehensive analysis including: identification of all N+1 queries with SQL examples, optimized solutions using eager loading (with/load), select optimization, advanced techniques (withCount/withSum/subqueries), nested relationship loading, performance comparisons, missing indexes, caching strategies, pagination optimization, Laravel Debugbar output examples, automated tests for N+1 detection, and CI/CD integration setup.",
  "version": "1",
  "when": {
    "type": "fileEdited",
    "patterns": [
      "app/Http/Controllers/**/*.php",
      "app/Services/**/*.php",
      "app/Models/**/*.php",
      "app/Filament/Resources/**/*.php"
    ]
  },
  "then": {
    "type": "askAgent",
    "prompt": "Analyze the edited file for N+1 query problems and provide a comprehensive analysis:\n\n- use MCP servers, use mcp services\n\n1. **Identify ALL N+1 Queries:**\n   - Show the problematic code snippets\n   - Explain why each is an N+1 problem\n   - Show the SQL queries being generated (with examples)\n   - Calculate actual number of queries for realistic record counts (e.g., 10, 100, 1000 records)\n\n2. **Optimized Solutions:**\n   \n   **SOLUTION 1: Eager Loading**\n   ```php\n   // Show properly eager loaded relationships\n   // Use with() for simple eager loading\n   // Use load() for conditional loading\n   // Use lazy eager loading when appropriate\n   ```\n   \n   **SOLUTION 2: Select Optimization**\n   ```php\n   // Only select needed columns\n   // Use select() and addSelect()\n   ```\n   \n   **SOLUTION 3: Advanced Techniques**\n   ```php\n   // Subquery selects\n   // withCount(), withExists(), withSum(), withAvg(), withMin(), withMax()\n   // Conditional relationship loading\n   ```\n\n3. **Nested Relationship Loading:**\n   - Deep eager loading (e.g., users.posts.comments.author)\n   - Constrained eager loading with closures\n   - Morphed relationship loading\n\n4. **Performance Comparison:**\n   - Before: X queries (show breakdown)\n   - After: Y queries (show breakdown)\n   - Estimated execution time improvement\n   - Memory usage considerations\n\n5. **Query Optimization:**\n   - Missing indexes needed (with migration code)\n   - Composite indexes for complex queries\n   - Database-specific optimizations (SQLite in this case)\n\n6. **Caching Strategy:**\n   - What should be cached and why\n   - Cache invalidation strategy\n   - Cache tags and keys examples\n   - TTL recommendations\n\n7. **Pagination Optimization:**\n   - Cursor pagination for large datasets\n   - Load more vs traditional pagination\n   - Eager loading with pagination\n\n8. **Laravel Debugbar Output:**\n   - Show what Debugbar would display before optimization\n   - Show what Debugbar would display after optimization\n   - Explain key metrics (query count, execution time, memory)\n\n9. **Automated Testing:**\n   ```php\n   // Provide a Pest test to detect N+1 queries automatically\n   // Use assertQueryCount() or similar\n   ```\n\n10. **CI/CD Integration:**\n   - Setup for N+1 detection in CI pipeline\n   - Laravel Telescope query monitoring setup\n   - Performance regression detection\n\nProvide complete, optimized code with detailed explanations. Focus on Laravel 11 best practices, SQLite optimizations, and the multi-tenancy architecture used in this project (TenantScope). Consider the specific models in this project: Building, Property, Meter, MeterReading, Invoice, InvoiceItem, Tariff, Provider, User, Tenant."
  }
}