{
  "enabled": true,
  "name": "Laravel Legacy Code Refactoring Assistant",
  "description": "Automatically analyzes edited Laravel controller, service, or model files and provides comprehensive refactoring guidance following SOLID principles, modern PHP 8.2+ features, design patterns, and Laravel 12 best practices. Includes before/after comparisons, tests, optimization strategies, and migration plans.",
  "version": "1",
  "when": {
    "type": "fileEdited",
    "patterns": [
      "app/Http/Controllers/**/*.php",
      "app/Services/**/*.php",
      "app/Models/**/*.php"
    ]
  },
  "then": {
    "type": "askAgent",
    "prompt": "I need you to analyze this Laravel code file and provide a comprehensive refactoring plan to modern standards.\n\n- use MCP servers, use mcp services\n\nANALYZE THE CURRENT CODE FOR:\n1. Fat controllers with business logic\n2. Missing service layer abstractions\n3. Direct database queries in controllers\n4. Missing type hints and return types\n5. Lack of Form Request validation\n6. Missing API Resources for responses\n7. Opportunities for SOLID principles\n8. Missing design patterns (Repository, Strategy, Factory, Observer)\n9. Performance issues and N+1 queries\n10. Missing tests\n11. Lack of proper error handling\n12. Missing PHPDoc blocks\n\nPROVIDE A COMPLETE REFACTORING THAT INCLUDES:\n\n**1. SOLID Principles Application:**\n- Single Responsibility: Extract business logic into focused service classes\n- Open/Closed: Use interfaces and dependency injection\n- Liskov Substitution: Proper inheritance hierarchies\n- Interface Segregation: Focused interfaces\n- Dependency Inversion: Depend on abstractions\n\n**2. Modern Laravel 12 Patterns:**\n- Extract to Service classes (app/Services/)\n- Implement Form Requests (app/Http/Requests/)\n- Use API Resources for responses (if API endpoints)\n- Repository pattern if data access is complex (explain decision)\n- Use Eloquent relationships properly\n- Leverage query scopes\n\n**3. Modern PHP 8.2+ Features:**\n- Readonly properties where appropriate\n- Constructor property promotion\n- Named arguments\n- Match expressions instead of switch\n- Null-safe operator\n- Array unpacking\n- Enums for fixed value sets\n\n**4. Design Patterns:**\n- Strategy pattern for varying algorithms\n- Factory pattern for object creation\n- Observer pattern for event handling\n- Repository pattern for data access (if beneficial)\n- Explain WHY each pattern is used\n\n**5. Code Quality:**\n- Full type hints (parameters and return types)\n- Comprehensive PHPDoc blocks\n- Proper exception handling with custom exceptions\n- Validation moved to Form Requests\n- Remove code duplication\n\n**6. Performance Optimization:**\n- Identify and fix N+1 queries\n- Add eager loading where needed\n- Suggest caching strategies\n- Queue jobs for slow operations\n- Database query optimization\n\n**7. Testing:**\n- Provide Pest PHP tests for refactored code\n- Unit tests for services\n- Feature tests for controllers\n- Property-based tests where applicable\n- Mock external dependencies\n\n**8. Migration Strategy:**\n- List all breaking changes\n- Provide step-by-step migration plan\n- Suggest feature flags if needed\n- Backward compatibility considerations\n\n**FORMAT YOUR RESPONSE AS:**\n\n## Current Issues Analysis\n[List all problems found with severity levels]\n\n## Refactored Code\n\n### Before (Current Code)\n```php\n[Show relevant current code sections]\n```\n\n### After (Refactored Code)\n\n#### New Service Class\n```php\n[Complete service class implementation]\n```\n\n#### Refactored Controller\n```php\n[Slim controller using service]\n```\n\n#### Form Request\n```php\n[Validation logic extracted]\n```\n\n#### API Resource (if applicable)\n```php\n[Response formatting]\n```\n\n#### Repository (if used)\n```php\n[Data access abstraction]\n```\n\n## Design Patterns Applied\n[Explain each pattern and why it was chosen]\n\n## SOLID Principles Demonstrated\n[Show how each principle is applied]\n\n## Tests\n```php\n[Comprehensive Pest PHP tests]\n```\n\n## Performance Improvements\n- [List optimizations with before/after metrics]\n- [Caching strategy]\n- [Queue jobs]\n\n## Breaking Changes\n[Complete list with impact assessment]\n\n## Migration Plan\n1. [Step-by-step migration instructions]\n2. [Rollback strategy]\n3. [Testing checklist]\n\n## Additional Recommendations\n[Future improvements, monitoring, documentation needs]\n\nMake this production-ready, maintainable, and following Laravel 12 + PHP 8.2+ best practices. Reference the project's existing patterns (TenantScope, Enums, Services structure) where applicable."
  }
}