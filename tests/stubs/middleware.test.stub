<?php

use App\Http\Middleware\{{ middlewareName }};
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Http\Request;

uses(RefreshDatabase::class);

beforeEach(function () {
    $this->middleware = new {{ middlewareName }}();
});

describe('{{ middlewareName }} Middleware', function () {
    it('allows request to proceed when conditions are met', function () {
        $this->actingAsAdmin();
        
        $request = Request::create('/test', 'GET');
        $next = fn($req) => response('OK');

        $response = $this->middleware->handle($request, $next);

        expect($response->getContent())->toBe('OK');
    });

    it('blocks request when conditions are not met', function () {
        $request = Request::create('/test', 'GET');
        $next = fn($req) => response('OK');

        $response = $this->middleware->handle($request, $next);

        expect($response->status())->toBe(403);
    });

    it('respects tenant context', function () {
        $this->actingAsAdmin();
        
        $request = Request::create('/test', 'GET');
        $next = fn($req) => response('OK');

        $response = $this->middleware->handle($request, $next);

        expect(auth()->user()->tenant_id)->not->toBeNull();
    });

    it('handles unauthenticated requests', function () {
        $request = Request::create('/test', 'GET');
        $next = fn($req) => response('OK');

        $response = $this->middleware->handle($request, $next);

        expect($response->status())->toBe(302); // Redirect to login
    });

    it('logs middleware execution', function () {
        \Illuminate\Support\Facades\Log::spy();
        
        $this->actingAsAdmin();
        $request = Request::create('/test', 'GET');
        $next = fn($req) => response('OK');

        $this->middleware->handle($request, $next);

        \Illuminate\Support\Facades\Log::shouldHaveReceived('debug');
    });
});
